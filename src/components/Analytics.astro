---
const GA_ID = import.meta.env.PUBLIC_GA4_ID;
const isProd = import.meta.env.MODE === "production";

interface Props {
  measurementId?: string;
}

const { measurementId = GA_ID } = Astro.props;
const shouldLoad = isProd && measurementId;
---

{shouldLoad && (
  <Fragment>
    <link rel="preconnect" href="https://www.googletagmanager.com" />
    <link rel="preconnect" href="https://www.google-analytics.com" />

    <script
      is:inline
      define:vars={{ measurementId }}
    >
      window.dataLayer = window.dataLayer || [];
      // eslint-disable-next-line prefer-rest-params
      function gtag() { dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("consent", "default", {
        ad_storage: "denied",
        analytics_storage: "denied",
      });

      const storedConsent = localStorage.getItem("analytics-consent");
      if (storedConsent === "granted") {
        gtag("consent", "update", { analytics_storage: "granted" });
      }

      gtag("config", measurementId, { send_page_view: false });

      window.addEventListener("load", function() {
        const s = document.createElement("script");
        s.src = "https://www.googletagmanager.com/gtag/js?id=" + measurementId;
        s.async = true;
        document.head.appendChild(s);
      });
      // eslint-enable no-var, prefer-rest-params
    </script>
  </Fragment>
)}

<script>
  import { analytics } from "../lib/analytics";

  const init = () => analytics.init();

  if ("requestIdleCallback" in window) {
    requestIdleCallback(init);
  } else {
    setTimeout(init, 200);
  }
</script>
