---
import Button from "./Button.astro";
import { cn } from "src/lib/utils";
---

<div
  id="cookie-banner"
  class={cn(
    "fixed inset-0 z-100",
    "flex items-end justify-center sm:items-center md:items-end md:justify-end p-4 md:p-6",
    "transition-all duration-500 ease-in-out",
    "opacity-0 pointer-events-none data-[state=open]:opacity-100 data-[state=open]:pointer-events-auto",
    "bg-background/80 backdrop-blur-sm md:bg-transparent md:backdrop-blur-none"
  )}
  role="alert"
  aria-live="polite"
  data-state="closed"
>
  <div
    class={cn(
      "bg-card border border-border rounded-xl shadow-lg",
      "w-full max-w-sm p-6 space-y-4 md:-mr-2 mb-10 md:mb-1",
      "translate-y-4 data-[state=open]:translate-y-0",
      "transition-transform duration-500 delay-100"
    )}
  >
    <div class="space-y-2">
      <h3 class="font-semibold leading-none tracking-tight">Cookie Settings</h3>
      <p class="text-sm text-muted-foreground">
        I use cookies to understand how you use this site and improve your experience. No personal data is collected.
        <a href="/privacy" class="underline underline-offset-4 hover:text-foreground">Read Privacy Policy</a>.
      </p>
    </div>
    <div class="flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 gap-2">
      <Button variant="ghost" size="sm" id="cookie-reject"> Decline </Button>
      <Button variant="default" size="sm" id="cookie-accept"> Accept Analytics </Button>
    </div>
  </div>
</div>

<script is:inline>
  (() => {
    const banner = document.getElementById("cookie-banner");
    const acceptBtn = document.getElementById("cookie-accept");
    const rejectBtn = document.getElementById("cookie-reject");

    // Check if element exists to avoid errors on pages without the banner
    if (!banner || !acceptBtn || !rejectBtn) return;

    const STORAGE_KEY = "analytics-consent";

    // Helper to update Google Analytics consent
    const updateConsent = (granted) => {
      const status = granted ? "granted" : "denied";

      if (typeof window.gtag === "function") {
        window.gtag("consent", "update", {
          analytics_storage: status,
          ad_storage: "denied", // Always denied as we don't use ads
        });
      }

      // Also update local storage for persistence
      localStorage.setItem(STORAGE_KEY, status);
    };

    // Initialize state based on stored preference
    const storedConsent = localStorage.getItem(STORAGE_KEY);

    if (storedConsent) {
      // If we have a stored preference, apply it
      updateConsent(storedConsent === "granted");
    } else {
      // If no preference stored, show the banner
      // Small delay to ensure smooth entry animation
      setTimeout(() => {
        banner.dataset.state = "open";
      }, 1000);
    }

    // Event Listeners
    acceptBtn.addEventListener("click", () => {
      updateConsent(true);
      banner.dataset.state = "closed";
    });

    rejectBtn.addEventListener("click", () => {
      updateConsent(false);
      banner.dataset.state = "closed";
    });

    // Listen for custom event to reopen settings
    document.addEventListener("open-cookie-settings", () => {
      banner.dataset.state = "open";
    });
  })();
</script>
